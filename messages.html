<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Shared Messages</title>
    <!-- Add any CSS styles here -->
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f0f2f5;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        font-size: 16px;
      }
      #submit-button,
      #clear-button {
        padding: 10px 20px;
        margin-top: 10px;
        font-size: 16px;
      }
      #clear-button {
        margin-left: 10px;
      }
      #messages {
        margin-top: 30px;
      }
      .message {
        border-bottom: 1px solid #ccc;
        padding: 10px 0;
      }
      .message p {
        margin-bottom: 5px;
        white-space: pre-wrap; /* Preserves whitespace and line breaks */
      }
      .message small {
        color: #777;
      }
    </style>
  </head>
  <body>
    <h1>Shared Messages</h1>

    <!-- Content Submission -->
    <textarea
      id="message-input"
      placeholder="Paste your content here"
    ></textarea>
    <br />
    <button id="submit-button">Submit</button>
    <button id="clear-button">Clear All Messages</button>

    <!-- Messages Display -->
    <div id="messages"></div>

    <!-- Include Firebase SDK -->
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <!-- Include DOMPurify for sanitizing HTML content -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
    <!-- Include Marked.js for parsing Markdown (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Your JavaScript Code -->
    <script>
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBWQInIKD-QiQ-GurDvz8VIFdzvA5bKks0",
        authDomain: "jiglo-47ad7.firebaseapp.com",
        projectId: "jiglo-47ad7",
        storageBucket: "jiglo-47ad7.appspot.com",
        messagingSenderId: "580350650870",
        appId: "1:580350650870:web:a2ceb2e73615ab97f73fd7",
        measurementId: "G-VSLLNMXXNR",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const messageInput = document.getElementById("message-input");
      const submitButton = document.getElementById("submit-button");
      const clearButton = document.getElementById("clear-button");
      const messagesDiv = document.getElementById("messages");

      // Function to load messages
      function loadMessages() {
        messagesDiv.innerHTML = "";
        db.collection("messages")
          .orderBy("timestamp")
          .onSnapshot((snapshot) => {
            messagesDiv.innerHTML = "";
            snapshot.forEach((doc) => {
              const messageData = doc.data();
              const messageDiv = document.createElement("div");
              messageDiv.classList.add("message");
              const timestamp = messageData.timestamp
                ? messageData.timestamp.toDate().toLocaleString()
                : "Unknown time";

              // Sanitize and parse content (Markdown optional)
              // For plain text with formatting preserved
              // const sanitizedContent = DOMPurify.sanitize(messageData.content);

              // For Markdown parsing (uncomment the following lines)
              const parsedMarkdown = marked.parse(messageData.content);
              const sanitizedContent = DOMPurify.sanitize(parsedMarkdown);

              // Create message elements
              const messageParagraph = document.createElement("p");
              messageParagraph.innerHTML = sanitizedContent; // Use innerHTML to preserve formatting

              const timestampSmall = document.createElement("small");
              timestampSmall.textContent = timestamp;

              // Append elements
              messageDiv.appendChild(messageParagraph);
              messageDiv.appendChild(timestampSmall);
              messagesDiv.appendChild(messageDiv);
            });
          });
      }

      // Load messages on page load
      loadMessages();

      // Submit button event listener
      submitButton.addEventListener("click", () => {
        const content = messageInput.value.trim();
        if (!content) return;

        // Save message to Firestore
        db.collection("messages")
          .add({
            content: content,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          })
          .then(() => {
            messageInput.value = "";
            // Message will appear automatically due to real-time listener
          })
          .catch((error) => {
            console.error("Error adding message: ", error);
          });
      });

      // Clear button event listener
      clearButton.addEventListener("click", () => {
        if (confirm("Are you sure you want to clear all messages?")) {
          // Delete all messages
          db.collection("messages")
            .get()
            .then((querySnapshot) => {
              const batch = db.batch();
              querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
              });
              return batch.commit();
            })
            .then(() => {
              // Messages will be removed automatically due to real-time listener
            })
            .catch((error) => {
              console.error("Error deleting messages: ", error);
            });
        }
      });
    </script>
  </body>
</html>
